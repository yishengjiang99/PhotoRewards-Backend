<?php
require_once("/var/www/lib/functions.php");
$r=$_REQUEST;
$uid=intval($r['uid']);
if($uid==0){
 $uid=$_COOKIE['uid'];
}
$newuser=1;
if($uid!=0){
 $newuser=0;
 setcookie("uid",$uid,time()+36000);
 $user=db::row("select * from appuser where id=$uid");
}

if(isset($r['pid'])){
 $pid=stripslashes($r['pid']);
 $pic=db::row("select * from UploadPictures where id='$pid'");
}else{
 $pic=db::row("select * from UploadPictures where type='Santa' and points_earned<50 order by RAND() limit 1");
 $pid=$pic['id'];
}

$uploaderId=$pic['uid'];
$points=$info['points_earned'];
$e_msg="";

if($pid>0 && $r['o']=='liked'){
  if($r['h']==md5($uid.$pid."asdfadss") && $uid>0){
    $liked=db::row("select * from PicturesLiked where liker_uid=$uid and liked_picture_id='$pid'");
    if($liked){
	$e_msg="You already liked this picture";
    }else{
     $points=$points+4;
     if($points<100 && $user['tracking']<10){
      db::exec("update UploadPictures set points_earned=$points where id='$pid'");
      db::exec("update appuser set stars=stars+4 where id=$uploaderId");
      db::exec("insert into PicturesLiked set liker_uid = $uid, liked_picture_id='$pid',liked_picture_id='$pid'");
      db::exec("update appuser set stars=stars+4 where id=$uid");
      $pic=db::row("select * from UploadPictures where type='Santa' and points_earned<50 order by RAND() limit 1");
      $pid=$pic['id'];
     }
    }
  } 
  if($uid==0){
     $e_msg="Please download PhotoRewards and earn points for sharing Photos";
  }
}

$uploaderId=$pic['uid'];
$points=$info['points_earned'];
$reportedandreturn=0;
if(isset($r['report']) && $pid && $user){
 $reportedandreturn=1;
 $username=$user['username'];
 if($username=='superadmin') $username='redcat';
 require_once("/var/www/html/pr/apns.php");
 $cc=$r['complaint'];
 apnsUser($upuid,"$username reported that your picture: $cc","$username reported that your picture: $cc","http://www.json999.com/pr/picture.php?id=$pid");
}

$url="http://www.json999.com/pr/p22.php?pid=$pid";
$cb="pid=$pid&h=".md5($uid.$pid."asdfadss")."&o=liked";
?>

<html>
<head>
<meta name = "viewport" content = "user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
</head>
 <a href='picrewards://' class=btn><h1>Back To PhotoRewards</h1></a>
<?php echo $e_msg ?>
<br>
<div id="fb-root"></div>
<div class="fb-like" data-href="<?php echo $url ?>" data-width="292" data-show-faces="false" data-header="false" data-stream="false" data-show-border="true"></div>
<script type="text/javascript">
    window.fbAsyncInit = function() {
        FB.init({appId: '146678772188121', status: true, cookie: true, xfbml: true});
        FB.Canvas.setSize({ width: 300, height: 500 });
        FB.Event.subscribe('edge.create',
            function(response) {
                 window.location = "https://www.json999.com/pr/p22.php?<?= $cb ?>";
            }
        );
    };
    //Load the SDK asynchronously
    (function() {
        var e = document.createElement('script'); e.async = true;
            e.src = document.location.protocol +
              '//connect.facebook.net/en_US/all.js';
            document.getElementById('fb-root').appendChild(e);
    }());
</script>
<br>
<?php if($uid>0){ ?>
<form method=POST>
<input type=hidden value='<?= $pid ?>' name='pid' />
<input type=hidden name=report value=1 />
<input type=hidden name=uid value=<?= $uid ?> />
Report this picture!
<br><select name='complaint'>
<option value='none'>Select reason</option>
<option value='Poor Quality'>Picture is poor quality</option>
<option value='spam'>Poster is spammer</option>
<option value='off topic'>Off-topic</option>
<option value='offensive'>Offensive/explicit</option>
</select>
<input type=submit value='complain' />
</form>
<?php } ?>
<img width=70% src='http://json999.com/pr/uploads/<?= $pid?>.jpeg'>
<script>
<?php if($reportedandreturn==1){
echo ' alert("Thanks for reporting this picture to the committee!");';
echo 'window.location="picrewards://"';
}?>
</script>
</html>
